<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Photo Capture System</title>
    <style>
        /* [Previous CSS styles remain exactly the same] */
    </style>
</head>
<body>
    <!-- [Previous HTML structure remains exactly the same] -->

    <script>
        // Configuration
        const SPREADSHEET_ID = '1E42C6IIupDSFCFexL0ouQteFtwiFoM1QyLwSo2rZRH0';
        const DRIVE_FOLDER_ID = '1RlSZT08HlcklTX81OotSM6s42YuRGF-4';
        const APPS_SCRIPT_BASE_URL = 'https://script.google.com/macros/s/AKfycby_FeDxwIleo12gWiWPHAQSDEpMl0BzKEKlnwacXoCK-gOHY-apF2HCFgEAje5S6UA/exec';

        // DOM Elements
        const elements = {
            classSectionDropdown: document.getElementById('classSectionDropdown'),
            rollNoDropdown: document.getElementById('rollNoDropdown'),
            studentCode: document.getElementById('studentCode'),
            studentName: document.getElementById('studentName'),
            contactNumber: document.getElementById('contactNumber'),
            cameraFeed: document.getElementById('cameraFeed'),
            canvas: document.getElementById('canvas'),
            capturedImage: document.getElementById('capturedImage'),
            swapCameraButton: document.getElementById('swapCameraButton'),
            capturePictureButton: document.getElementById('capturePictureButton'),
            savePictureButton: document.getElementById('savePictureButton'),
            retakePictureButton: document.getElementById('retakePictureButton'),
            statusMessage: document.getElementById('statusMessage'),
            loadingSpinner: document.getElementById('loadingSpinner')
        };

        // State management
        const state = {
            currentStream: null,
            facingMode: 'user',
            currentStudent: null,
            capturedImageData: null
        };

        // Enhanced fetch with retry and timeout
        async function fetchWithRetry(url, options = {}, retries = 3, delay = 1000) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000);
            
            try {
                const response = await fetch(url, {...options, signal: controller.signal});
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                clearTimeout(timeoutId);
                if (retries > 0) {
                    console.log(`Retrying... (${retries} attempts left)`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithRetry(url, options, retries - 1, delay * 2);
                }
                throw error;
            }
        }

        // Utility Functions
        function showMessage(message, type = 'info') {
            elements.statusMessage.textContent = message;
            elements.statusMessage.className = `message ${type}`;
            elements.statusMessage.style.display = 'block';
            setTimeout(() => {
                elements.statusMessage.style.display = 'none';
            }, 5000);
        }

        function showLoading(show) {
            elements.loadingSpinner.style.display = show ? 'block' : 'none';
            const buttons = [
                elements.classSectionDropdown,
                elements.rollNoDropdown,
                elements.swapCameraButton,
                elements.capturePictureButton,
                elements.savePictureButton,
                elements.retakePictureButton
            ];
            buttons.forEach(btn => btn.disabled = show);
        }

        function resetStudentDetails() {
            elements.studentCode.textContent = 'N/A';
            elements.studentName.textContent = 'N/A';
            elements.contactNumber.textContent = 'N/A';
            state.currentStudent = null;
            elements.savePictureButton.disabled = true;
        }

        // Google Sheets Integration - Fixed Class Loading
        async function fetchSheetNames() {
            showLoading(true);
            elements.classSectionDropdown.innerHTML = '<option value="">Loading classes...</option>';
            elements.classSectionDropdown.disabled = true;
            
            try {
                // First test the connection
                const testResult = await fetchWithRetry(`${APPS_SCRIPT_BASE_URL}?action=testConnection`);
                if (!testResult || !testResult.status === 'success') {
                    throw new Error('Connection test failed');
                }

                // Then fetch sheet names
                const sheetNames = await fetchWithRetry(`${APPS_SCRIPT_BASE_URL}?action=getSheetNames`);
                
                if (!Array.isArray(sheetNames) || sheetNames.length === 0) {
                    throw new Error('No classes found in spreadsheet');
                }

                // Clear and rebuild dropdown
                elements.classSectionDropdown.innerHTML = '';
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Select Class & Section';
                elements.classSectionDropdown.appendChild(defaultOption);

                sheetNames.forEach(name => {
                    // Only add non-empty sheet names
                    if (name && name.trim() !== '') {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        elements.classSectionDropdown.appendChild(option);
                    }
                });
                
                if (elements.classSectionDropdown.options.length > 1) {
                    elements.classSectionDropdown.disabled = false;
                    showMessage('Classes loaded successfully', 'success');
                } else {
                    throw new Error('No valid classes found');
                }
            } catch (error) {
                console.error('Error loading classes:', error);
                elements.classSectionDropdown.innerHTML = '<option value="">Error Loading Classes</option>';
                elements.classSectionDropdown.disabled = false;
                
                let errorMessage = 'Failed to load classes';
                if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'Network error. Please check your connection.';
                } else if (error.message.includes('No classes found')) {
                    errorMessage = 'No classes found in spreadsheet.';
                }
                
                showMessage(errorMessage, 'error');
            } finally {
                showLoading(false);
            }
        }

        // [Rest of the functions remain the same as in previous complete version]

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            fetchSheetNames();
            startCamera(state.facingMode);
        });
    </script>
</body>
</html>
