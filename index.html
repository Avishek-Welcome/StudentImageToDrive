<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Student Photo Uploader</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    label, select, input { display: block; margin: 1rem 0; }
    #preview { width: 100px; aspect-ratio: 5 / 6.5; object-fit: cover; border: 1px solid #ccc; }
    video { width: 100%; max-width: 300px; aspect-ratio: 5 / 6.5; }
    button { padding: 0.5rem 1rem; margin-top: 1rem; }
  </style>
</head>
<body>

<h2>Student Photo Capture</h2>

<label>Class & Section:
  <select id="classSelect"></select>
</label>

<label>Roll No:
  <input type="text" id="rollInput" placeholder="Enter Roll No">
</label>

<div>
  <strong>Name:</strong> <span id="studentName">-</span><br>
  <strong>Code:</strong> <span id="studentCode">-</span>
</div>

<video id="video" autoplay muted playsinline></video>
<button onclick="capturePhoto()">Capture Photo</button>
<canvas id="canvas" style="display:none;"></canvas>
<img id="preview" src="">

<button onclick="uploadImage()">Upload</button>

<script>
const scriptURL = 'https://script.google.com/macros/s/AKfycby2ICxw_sHNRH4VxRic4mUnVTGG1nQhm0kxtWfosbOrkb8dXtQeexbgo4EXYMVS1THO/exec';
let studentCode = '', selectedClass = '', rollNo = '', imageData = '';

document.addEventListener('DOMContentLoaded', async () => {
  const res = await fetch(`${scriptURL}?action=getSheetNames`);
  const sheets = await res.json();
  const select = document.getElementById('classSelect');
  select.innerHTML = sheets.map(name => `<option value="${name}">${name}</option>`).join('');
});

document.getElementById('rollInput').addEventListener('change', async () => {
  selectedClass = document.getElementById('classSelect').value;
  rollNo = document.getElementById('rollInput').value.trim();
  const res = await fetch(`${scriptURL}?action=getSheetData&sheetName=${encodeURIComponent(selectedClass)}&rollNo=${encodeURIComponent(rollNo)}`);
  const data = await res.json();
  document.getElementById('studentName').textContent = data.name || '-';
  document.getElementById('studentCode').textContent = data.code || '-';
  studentCode = data.code;
});

navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } })
  .then(stream => document.getElementById('video').srcObject = stream);

function capturePhoto() {
  const canvas = document.getElementById('canvas');
  const video = document.getElementById('video');
  const ctx = canvas.getContext('2d');
  
  canvas.width = 500;
  canvas.height = 650;
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  imageData = canvas.toDataURL('image/jpeg').split(',')[1];
  document.getElementById('preview').src = canvas.toDataURL('image/jpeg');
}

async function uploadImage() {
  if (!imageData || !studentCode) return alert("Please capture photo first.");
  
  const uploadRes = await fetch(scriptURL, {
    method: 'POST',
    body: JSON.stringify({
      action: 'uploadImageToDrive',
      fileName: `${studentCode}.jpg`,
      imageData: imageData,
      folderId: '1RlSZT08HlcklTX81OotSM6s42YuRGF-4'
    })
  });

  const uploadJson = await uploadRes.json();
  if (!uploadJson.success) return alert("Upload failed: " + uploadJson.error);

  const saveRes = await fetch(scriptURL, {
    method: 'POST',
    body: JSON.stringify({
      action: 'saveImageLink',
      sheetName: selectedClass,
      rollNo: rollNo,
      imageLink: uploadJson.fileLink
    })
  });

  const saveJson = await saveRes.json();
  alert(saveJson.success ? "Image uploaded & saved!" : "Failed to save link");
}
</script>

</body>
</html>
