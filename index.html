<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Capture & Upload (5:6.5)</title>
  <style>
    video, canvas {
      display: block;
      margin: 10px auto;
      border: 1px solid #ccc;
    }
    #preview {
      width: 250px;
      height: 325px; /* 5:6.5 */
      object-fit: cover;
      border: 2px solid #333;
    }
  </style>
</head>
<body>
  <h2>Capture Photo (5:6.5 Ratio)</h2>

  <video id="video" autoplay playsinline width="500" height="650"></video>
  <button onclick="capture()">Capture</button>

  <br>
  <img id="preview" alt="Preview"><br>
  <button onclick="upload()">Upload to Drive</button>

  <script>
    const video = document.getElementById('video');
    const preview = document.getElementById('preview');
    const canvas = document.createElement('canvas');
    let capturedImageData = null;

    // Set desired output dimensions
    const outputWidth = 500;
    const outputHeight = 650;

    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
      .then(stream => { video.srcObject = stream; })
      .catch(err => alert("Camera access denied: " + err));

    function capture() {
      canvas.width = outputWidth;
      canvas.height = outputHeight;
      const ctx = canvas.getContext('2d');

      // Calculate cropping area (center-crop to 5:6.5 ratio)
      const videoRatio = video.videoWidth / video.videoHeight;
      const targetRatio = outputWidth / outputHeight;

      let sx = 0, sy = 0, sw = video.videoWidth, sh = video.videoHeight;

      if (videoRatio > targetRatio) {
        // Crop horizontally
        sw = video.videoHeight * targetRatio;
        sx = (video.videoWidth - sw) / 2;
      } else {
        // Crop vertically
        sh = video.videoWidth / targetRatio;
        sy = (video.videoHeight - sh) / 2;
      }

      ctx.drawImage(video, sx, sy, sw, sh, 0, 0, outputWidth, outputHeight);
      capturedImageData = canvas.toDataURL('image/jpeg', 0.9);
      preview.src = capturedImageData;
    }

    function upload() {
      if (!capturedImageData) return alert("Capture a photo first.");

      fetch('https://script.google.com/macros/s/AKfycbyR9CqUrAIKoOpBZ4hgUSwG4FZGNLNiqcog1fxb82HTuDhPpaiBqJoXH0zqCMKmpZQA/exec', {
        method: 'POST',
        body: JSON.stringify({
          imageData: capturedImageData,
          filename: `photo_${Date.now()}.jpg`
        }),
        headers: { 'Content-Type': 'application/json' }
      })
      .then(res => res.json())
      .then(data => alert(data.message))
      .catch(err => alert("Upload error: " + err));
    }
  </script>
</body>
</html>
